<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-header-panel/paper-header-panel.html">

<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../iron-pages/iron-pages.html">

<link rel="import" href="../paper-styles/color.html">
<link rel="import" href="../paper-styles/default-theme.html">
<link rel="import" href="../paper-styles/shadow.html">
<link rel="import" href="../paper-styles/typography.html">

<link rel="import" href="../strolch-wc-styles/strolch-wc-styles.html">

<dom-module id="strolch-wc-inspector-object">

    <template>

        <style is="strolch-wc-styles">

            :host {
                display: block;
            }

            .card {
                padding: 1.0em;
                margin: 1.0em;
                cursor: pointer;
            }

            .title-bar {
                background-color: var(--google-grey-300);
                color: var(--google-grey-700);
            }

            .title {
                padding: 8px;
                background-color: rgb(224, 224, 224);
                color: rgb(97, 97, 97);
                font-size: 16px;
                font-weight: 400;
                line-height: 1.3;
                margin: 0;
            }

            .sub {
                font-size: small;
            }

            .table-title {
                margin-bottom: 0;
                padding: 0;
            }

            paper-material {
                border-radius: 2px;
                background-color: #ffffff;
            }

            paper-tabs {
                border-top: solid #7F7F7F 1px;
                --paper-tabs-selection-bar-color: var(--paper-amber-600);
                background-color: #ffffff;
                color: #000000;
            }

        </style>

        <paper-material class="g-card g-m-3 g-mt-4" elevation="1">

            <div class="g-container">
                <div class="g-row title-bar" on-tap="_toggleExpanded">

                    <div class="g-11">
                        <h1 class="title"><span style="text-transform: uppercase">[[summary.objectType]]</span> <span
                                class="sub g-ml-4">Id:</span> [[summary.id]] <span class="sub g-ml-4">Name:</span>
                                                              [[summary.name]] <span class="sub g-ml-4">Type:</span>
                                                              [[summary.type]] </h1>
                    </div>

                    <div class="g-1">
                        <paper-icon-button id="expandedIcon" icon="expand-more"></paper-icon-button>
                    </div>

                </div>
                <div class="g-row">
                    <div class="g-12">

                        <!-- Tabs -->
                        <template is="dom-if" if="[[expanded]]">
                            <paper-tabs selected="{{selectedDetailType}}"
                                        attr-for-selected="name"
                                        fallback-selection="none">
                                <paper-tab name="details">Details</paper-tab>
                                <paper-tab name="parameters">Parameters</paper-tab>
                                <paper-tab name="policies">Policies</paper-tab>
                                <template is="dom-if" if="[[_isResource(summary.objectType)]]">
                                    <paper-tab name="timedstates">Timed States</paper-tab>
                                </template>
                                <template is="dom-if" if="[[_isActivity(summary.objectType)]]">
                                    <paper-tab name="elements">Elements</paper-tab>
                                </template>
                            </paper-tabs>
                        </template>

                        <!-- Tab sections -->
                        <iron-pages selected="[[selectedDetailType]]" attr-for-selected="name">

                            <!-- details -->
                            <section name="details" class="g-p-2 g-pt-0">
                                <template is="dom-if" if="[[!details]]">
                                    <p class="g-center">Loading...</p>
                                </template>
                                <template is="dom-if" if="[[details]]">

                                    <div class="g-row">

                                        <div class="g-6">

                                            <dl class="g-dl">
                                                <dt>Id</dt>
                                                <dd>[[details.id]]</dd>
                                                <dt>Name</dt>
                                                <dd>[[details.name]]</dd>
                                                <dt>Type</dt>
                                                <dd>[[details.type]]</dd>
                                            </dl>

                                            <template is="dom-if"
                                                      if="[[_isActivity(details.objectType)]]"
                                                      restamp="true">
                                                <dl class="g-dl">
                                                    <dt>State</dt>
                                                    <dd>[[details.state]]</dd>
                                                    <dt>TimeOrdering</dt>
                                                    <dd>[[details.timeOrdering]]</dd>
                                                    <dt>Start</dt>
                                                    <dd>[[_formatDate(details.start)]]</dd>
                                                    <dt>End</dt>
                                                    <dd>[[_formatDate(details.end)]]</dd>
                                                </dl>
                                            </template>

                                            <template is="dom-if" if="[[_isOrder(details.objectType)]]" restamp="true">
                                                <dl class="g-dl">
                                                    <dt>State</dt>
                                                    <dd>[[details.state]]</dd>
                                                    <dt>Date</dt>
                                                    <dd>[[_formatDate(details.date)]]</dd>
                                                </dl>
                                            </template>

                                            <template is="dom-if" if="[[_isAction(details.objectType)]]" restamp="true">
                                                <dl class="g-dl">
                                                    <dt>State</dt>
                                                    <dd>[[details.state]]</dd>
                                                    <dt>Start</dt>
                                                    <dd>[[_formatDate(details.start)]]</dd>
                                                    <dt>End</dt>
                                                    <dd>[[_formatDate(details.end)]]</dd>
                                                    <dt>Resource Type</dt>
                                                    <dd>[[details.resourceType]]</dd>
                                                    <dt>Resource Id</dt>
                                                    <dd>[[details.resourceId]]</dd>
                                                </dl>
                                            </template>

                                        </div>

                                        <div class="g-6">

                                            <template is="dom-if" if="[[details.version]]" restamp="true">
                                                <dl class="g-dl">
                                                    <dt>CreatedAt</dt>
                                                    <dd>[[_formatDate(details.version.createdAt)]]</dd>
                                                    <dt>CreatedBy</dt>
                                                    <dd>[[details.version.createdBy]]</dd>
                                                    <dt>Deleted</dt>
                                                    <dd>[[details.version.deleted]]</dd>
                                                    <dt>Version</dt>
                                                    <dd>[[details.version.version]]</dd>
                                                </dl>
                                            </template>

                                        </div>

                                    </div>

                                </template>
                            </section>

                            <!-- parameters -->
                            <section name="parameters" class="g-p-2 g-pt-0">
                                <template is="dom-if" if="[[!details]]">
                                    <p class="g-center">Loading...</p>
                                </template>
                                <template is="dom-if" if="[[details]]">

                                    <template is="dom-if" if="[[_isEmpty(details.parameterBags)]]">
                                        <p class="g-center">No parameters defined on [[summary.objectType]]
                                                            [[summary.id]]</p>
                                    </template>
                                    <template is="dom-if" if="[[_isNotEmpty(details.parameterBags)]]">

                                        <table class="g-table">
                                            <thead>
                                            <tr>
                                                <th>ParameterBag</th>
                                                <th>Parameter Id</th>
                                                <th>Name</th>
                                                <th>Interpretation</th>
                                                <th>UOM</th>
                                                <th>Type</th>
                                                <th>Value</th>
                                            </tr>
                                            </thead>

                                            <tbody>

                                            <template is="dom-repeat"
                                                      items="{{_asArray(details.parameterBags)}}"
                                                      as="bag">
                                                <template is="dom-repeat"
                                                          items="{{_asArray(bag.value.parameters)}}"
                                                          as="param">

                                                    <tr>
                                                        <td>[[bag.value.id]]</td>
                                                        <td>[[param.value.id]]</td>
                                                        <td>[[param.value.name]]</td>
                                                        <td>[[param.value.interpretation]]</td>
                                                        <td>[[param.value.uom]]</td>
                                                        <td>[[param.value.type]]</td>
                                                        <td>[[param.value.value]]</td>
                                                    </tr>

                                                </template>
                                            </template>

                                            </tbody>
                                        </table>
                                    </template>

                                </template>
                            </section>

                            <!-- policies -->
                            <section name="policies" class="g-p-2 g-pt-0">
                                <template is="dom-if" if="[[!details]]">
                                    <p class="g-m-4 g-center">Loading...</p>
                                </template>
                                <template is="dom-if" if="[[details]]">

                                    <template is="dom-if" if="[[_isEmpty(details.policies)]]">
                                        <p class="g-pt-4 g-center">No policies defined on [[objectName]]
                                                                   [[summary.id]]</p>
                                    </template>
                                    <template is="dom-if" if="[[_isNotEmpty(details.policies)]]">

                                        <table class="g-table">
                                            <thead>
                                            <tr>
                                                <th>Type</th>
                                                <th>Value</th>
                                            </tr>
                                            </thead>

                                            <tbody>

                                            <template is="dom-repeat"
                                                      items="{{_asArray(details.policies)}}"
                                                      as="policy">

                                                <tr>
                                                    <td>[[policy.key]]</td>
                                                    <td>[[policy.value]]</td>
                                                </tr>

                                            </template>

                                            </tbody>
                                        </table>
                                    </template>

                                </template>
                            </section>

                            <!-- timedstates -->
                            <template is="dom-if" if="[[_isResource(summary.objectType)]]">
                                <section name="timedstates" class="g-p-2 g-pt-0">
                                    <template is="dom-if" if="[[!details]]">
                                        <p class="g-center">Loading...</p>
                                    </template>
                                    <template is="dom-if" if="[[details]]">

                                        <template is="dom-if" if="[[_isEmpty(details.timedStates)]]">
                                            <p class="g-pt-4 g-center">No timed states defined on [[objectName]]
                                                                       [[summary.id]]</p>
                                        </template>
                                        <template is="dom-if" if="[[_isNotEmpty(details.timedStates)]]">
                                            <template is="dom-repeat"
                                                      items="[[_asArray(details.timedStates)]]"
                                                      as="timedState">

                                                <paper-material class="g-card" elevation="1">
                                                    <table class="g-table table-title">
                                                        <tbody>
                                                        <tr>
                                                            <td><b>Id</b> [[timedState.value.id]]</td>
                                                            <td><b>Name</b> [[timedState.value.name]]</td>
                                                            <td><b>Type</b> [[timedState.value.type]]</td>
                                                        </tr>
                                                        </tbody>
                                                    </table>

                                                    <table class="g-table">
                                                        <thead>
                                                        <tr>
                                                            <th>Time</th>
                                                            <th>Value</th>
                                                        </tr>
                                                        </thead>
                                                        <tbody>
                                                        <template is="dom-repeat"
                                                                  items="[[timedState.value.values]]"
                                                                  as="timedStateValue">
                                                            <tr>
                                                                <td>[[timedStateValue.time]]</td>
                                                                <td>[[timedStateValue.value]]</td>
                                                            </tr>
                                                        </template>
                                                        </tbody>
                                                    </table>

                                                </paper-material>

                                            </template>
                                        </template>

                                    </template>
                                </section>
                            </template>

                            <!-- activity children -->
                            <template is="dom-if" if="[[_isActivity(summary.objectType)]]">
                                <section name="elements" class="g-p-2 g-pt-0">
                                    <template is="dom-if" if="[[!details]]">
                                        <p class="g-center">Loading...</p>
                                    </template>
                                    <template is="dom-if" if="[[details]]">

                                        <template is="dom-repeat" items="[[details.elements]]" as="childElement">
                                            <strolch-wc-inspector-object base-path="[[basePath]]"
                                                                         app="[[app]]"
                                                                         realm="[[realm]]"
                                                                         details="[[childElement]]"
                                                                         summary="[[childElement]]"
                                                                         class="g-m-2"></strolch-wc-inspector-object>
                                        </template>

                                    </template>
                                </section>
                            </template>

                        </iron-pages>

                    </div>
                </div>
            </div>

        </paper-material>

        <iron-ajax id="ajax"
                   content-type="application/json"
                   handle-as="json"
                   on-response="_handleAjaxResponse"
                   on-error="_handleAjaxError"></iron-ajax>

    </template>

    <script>

        Polymer({

            is: 'strolch-wc-inspector-object',

            properties: {
                app: {
                    type: Object,
                    value: function () {
                        return null;
                    }
                },
                basePath: {
                    type: String,
                    value: './'
                },
                realm: {
                    type: String,
                    value: function () {
                        return null;
                    }
                },
                summary: {
                    type: Object,
                    value: function () {
                        return null;
                    }
                },
                details: {
                    type: Object,
                    value: function () {
                        return null;
                    }
                },
                expanded: {
                    type: Boolean,
                    value: function () {
                        return false;
                    }
                },
                selectedDetailType: {
                    type: String,
                    value: function () {
                        return true;
                    },
                    observer: "selectedDetailTypeChanged"
                }
            },

            _typeSubPath: function (selectedType) {
                if (selectedType == 'Resource') {
                    return 'resources';
                } else if (selectedType == 'Order') {
                    return 'orders';
                } else if (selectedType == 'Activity') {
                    return 'activities';
                } else {
                    throw 'Unhandled selected type ' + selectedType;
                }
            },

            _isResource: function (objectType) {
                return objectType == 'Resource';
            },
            _isOrder: function (objectType) {
                return objectType == 'Order';
            },
            _isActivity: function (objectType) {
                return objectType == 'Activity';
            },
            _isAction: function (objectType) {
                return objectType == 'Action';
            },

            _isEmpty: function (obj) {
                if (obj == null)
                    return true;
                if (obj instanceof Array) {
                    return obj.length == 0;
                } else if (obj instanceof Object) {
                    return Object.keys(obj).length == 0;
                }

                return true;
            },
            _isNotEmpty: function (obj) {
                return !this._isEmpty(obj);
            },

            _asArray: function (obj) {
                if (!obj)
                    return [];
                return Object.keys(obj).map(function (key) {
                    return {
                        key: key,
                        value: obj[key]
                    };
                });
            },

            _formatDate: function (date) {
                return Strolch.toDateTime(date);
            },

            _toggleExpanded: function (evt) {
                this.expanded = !this.expanded;
                this.$.expandedIcon.icon = this.expanded ? 'expand-less' : 'expand-more';

                if (!this.expanded) {
                    this.selectedDetailType = null;
                }
            },

            selectedDetailTypeChanged: function (newValue, oldValue) {
                if (newValue != null) {
                    console.log('Selected detail type changed from ' + oldValue + " to " + newValue);
                    this.reloadDetails();
                }
            },

            reloadDetails: function () {

                if (this.details != null)
                    return;

                this._handleAjaxResponse = function (data) {
                    this.details = data.detail.response;
                    console.log(this.objectType);
                    console.log(this.details);
                };

                this.$.ajax.url = this.basePath + 'rest/strolch/inspector/' + this.realm + '/' + this._typeSubPath(this.summary.objectType) + '/' + this.summary.type + '/' + this.summary.id;
                this.$.ajax.method = 'GET';
                this.$.ajax.generateRequest();
            },

            ready: function () {

            },

            reload: function () {

            },

            _handleAjaxResponse: function (evt) {
                console.log('NOT YET DEFINED!');
            },

            _handleAjaxError: function (data) {
                var dlgTitle = 'Debug action failed';
                var dlgText;
                if (data.detail.request.response) {
                    dlgText = data.detail.request.response.msg;
                } else {
                    dlgText = data.detail.error;
                }
                this.app.showError(dlgTitle, dlgText);
            }
        });

    </script>

</dom-module>
