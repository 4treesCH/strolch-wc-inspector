<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../iron-ajax/iron-ajax.html">

<link rel="import" href="../paper-styles/color.html">
<link rel="import" href="../paper-styles/default-theme.html">
<link rel="import" href="../paper-styles/shadow.html">
<link rel="import" href="../paper-styles/typography.html">

<dom-module id="strolch-wc-inspector-object">

    <link rel="import" type="css" href="../bootstrap/dist/css/bootstrap.css">
    <link rel="import" type="css" href="../components-font-awesome/css/font-awesome.min.css">

    <template>

        <style>

            :host {
                display: block;
            }

            .card {
                padding: 1.0em;
                margin: 1.0em;
                cursor: pointer;
            }

            .title {
                font-weight: bold;
            }

            .table-title td {
                border: none;
                padding: 0;
            }

        </style>

        <paper-material class="card" elevation="1">

            <div class="row">
                <div class="col-6">

                    <table class="table table-sm table-title">
                        <tr>
                            <td><span class="title">Id</span></td>
                            <td>[[summary.id]]</td>
                        </tr>
                        <tr>
                            <td><span class="title">Name</span></td>
                            <td>[[summary.name]]</td>
                        </tr>
                        <tr>
                            <td><span class="title">Type</span></td>
                            <td>[[summary.type]]</td>
                        </tr>
                        <template is="dom-if" if="[[summary.state]]">
                            <tr>
                                <td><span class="title">State</span></td>
                                <td>[[summary.state]]</td>
                            </tr>
                        </template>
                        <template is="dom-if" if="[[summary.date]]">
                            <tr>
                                <td><span class="title">Date</span></td>
                                <td>[[summary.date]]</td>
                            </tr>
                        </template>
                    </table>

                </div>
            </div>

            <!-- Parameters -->
            <div class="row">
                <div class="col-12" hidden="[[!hideParams]]">
                    <paper-material class="card" elevation="1" on-tap="toggleParams">
                        Show parameters
                    </paper-material>
                </div>
                <div class="col-12" hidden="[[hideParams]]">

                    <paper-material class="card" elevation="1">
                        <h5 on-tap="toggleParams">Parameters</h5>
                        <template is="dom-if" if="[[!details]]">
                            <p class="title text-center">Loading...</p>
                        </template>
                        <template is="dom-if" if="[[details]]">

                            <table class="table table-sm">
                                <thead>
                                <tr>
                                    <th>ParameterBag</th>
                                    <th>Parameter Id</th>
                                    <th>Name</th>
                                    <th>Interpretation</th>
                                    <th>UOM</th>
                                    <th>Type</th>
                                    <th>Value</th>
                                </tr>
                                </thead>

                                <tbody>

                                <template is="dom-repeat" items="{{_asArray(details.parameterBags)}}" as="bag">
                                    <template is="dom-repeat" items="{{_asArray(bag.value.parameters)}}" as="param">

                                        <tr>
                                            <td>[[bag.value.id]]</td>
                                            <td>[[param.value.id]]</td>
                                            <td>[[param.value.name]]</td>
                                            <td>[[param.value.interpretation]]</td>
                                            <td>[[param.value.uom]]</td>
                                            <td>[[param.value.type]]</td>
                                            <td>[[param.value.value]]</td>
                                        </tr>

                                    </template>
                                </template>

                                </tbody>
                            </table>

                        </template>
                    </paper-material>

                </div>
            </div>

            <!-- Policies -->
            <div class="row">
                <div class="col-12" hidden="[[!hidePolicies]]">
                    <paper-material class="card" elevation="1" on-tap="togglePolicies">
                        Show Policies
                    </paper-material>
                </div>
                <div class="col-12" hidden="[[hidePolicies]]">

                    <paper-material class="card" elevation="1">
                        <h5 on-tap="togglePolicies">Policies</h5>
                        <template is="dom-if" if="[[!details]]">
                            <p class="title text-center">Loading...</p>
                        </template>
                        <template is="dom-if" if="[[details]]">

                            <table class="table table-sm">
                                <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Value</th>
                                </tr>
                                </thead>

                                <tbody>

                                <template is="dom-repeat" items="{{_asArray(details.policies)}}" as="policy">

                                    <tr>
                                        <td>[[policy.key]]</td>
                                        <td>[[policy.value]]</td>
                                    </tr>

                                </template>

                                </tbody>
                            </table>

                        </template>
                    </paper-material>

                </div>
            </div>

            <!-- Timed States -->
            <template is="dom-if" if="[[_isResource(objectType)]]">

                <div class="row">
                    <div class="col-12" hidden="[[!hideTimedStates]]">
                        <paper-material class="card" elevation="1" on-tap="toggleTimedStates">
                            Show Timed States
                        </paper-material>
                    </div>
                    <div class="col-12" hidden="[[hideTimedStates]]">

                        <paper-material class="card" elevation="1">
                            <h5 on-tap="toggleTimedStates">Timed States</h5>
                            <template is="dom-if" if="[[!details]]">
                                <p class="title text-center">Loading...</p>
                            </template>
                            <template is="dom-if" if="[[details]]">

                                <template is="dom-repeat" items="[[_asArray(details.timedStates)]]" as="timedState">

                                    <paper-material class="card" elevation="1">
                                        <table class="table table-sm table-title">
                                            <tbody>
                                            <tr>
                                                <td><span class="title">Id</span> [[timedState.value.id]]</td>
                                                <td><span class="title">Name</span> [[timedState.value.name]]</td>
                                                <td><span class="title">Type</span> [[timedState.value.type]]</td>
                                            </tr>
                                            </tbody>
                                        </table>

                                        <table class="table table-sm">
                                            <thead>
                                            <tr>
                                                <th>Time</th>
                                                <th>Value</th>
                                            </tr>
                                            </thead>
                                            <tbody>
                                            <template is="dom-repeat"
                                                      items="[[timedState.value.values]]"
                                                      as="timedStateValue">
                                                <tr>
                                                    <td>[[timedStateValue.time]]</td>
                                                    <td>[[timedStateValue.value]]</td>
                                                </tr>
                                            </template>
                                            </tbody>
                                        </table>

                                    </paper-material>

                                </template>

                            </template>
                        </paper-material>

                    </div>
                </div>


            </template>

        </paper-material>

        <iron-ajax id="ajax"
                   content-type="application/json"
                   handle-as="json"
                   on-response="_handleAjaxResponse"
                   on-error="_handleAjaxError"></iron-ajax>

    </template>

    <script>

        Polymer({

            is: 'strolch-wc-inspector-object',

            properties: {
                app: {
                    type: Object,
                    value: function () {
                        return null;
                    }
                },
                realm: {
                    type: Object,
                    value: function () {
                        return null;
                    }
                },
                objectName: {
                    type: Object,
                    value: function () {
                        return null;
                    }
                },
                objectType: {
                    type: Object,
                    value: function () {
                        return null;
                    }
                },
                summary: {
                    type: Object,
                    value: function () {
                        return null;
                    }
                },
                details: {
                    type: Object,
                    value: function () {
                        return null;
                    }
                },
                hideParams: {
                    type: Boolean,
                    value: function () {
                        return true;
                    }
                },
                hidePolicies: {
                    type: Boolean,
                    value: function () {
                        return true;
                    }
                },
                hideTimedStates: {
                    type: Boolean,
                    value: function () {
                        return true;
                    }
                }
            },

            _isResource: function (objectType) {
                return objectType == 'resources';
            },
            _isOrder: function (objectType) {
                return objectType == 'orders';
            },
            _isActivity: function (objectType) {
                return objectType == 'activities';
            },

            _asArray: function (obj) {
                if (!obj)
                    return [];
                return Object.keys(obj).map(function (key) {
                    return {
                        key: key,
                        value: obj[key]
                    };
                });
            },

            toggleParams: function () {
                this.hideParams = !this.hideParams;
                this.reloadDetails(this.hideParams);
            },
            togglePolicies: function () {
                this.hidePolicies = !this.hidePolicies;
                this.reloadDetails(this.hidePolicies);
            },
            toggleTimedStates: function () {
                this.hideTimedStates = !this.hideTimedStates;
                this.reloadDetails(this.hideTimedStates);
            },

            reloadDetails: function (hide) {
                if (hide)
                    return;
                if (this.details != null)
                    return;

                var that = this;
                setTimeout(function () {
                    that.details = null;

                    that._handleAjaxResponse = function (data) {
                        that.details = data.detail.response;
                    };

                    that.$.ajax.url = './rest/strolch/inspector/' + that.realm + '/' + that.objectType + '/' + that.summary.type + '/' + that.summary.id;
                    that.$.ajax.method = 'GET';
                    that.$.ajax.generateRequest();
                }, 10);

            },

            ready: function () {

            },

            reload: function () {

            },

            _handleAjaxResponse: function (evt) {
                console.log('NOT YET DEFINED!');
            },

            _handleAjaxError: function (data) {
                var dlgTitle = 'Debug action failed';
                var dlgText;
                if (data.detail.request.response) {
                    dlgText = data.detail.request.response.msg;
                } else {
                    dlgText = data.detail.error;
                }
                this.app.showError(dlgTitle, dlgText);
            }
        });

    </script>

</dom-module>
